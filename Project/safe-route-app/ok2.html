<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Safety</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            base: {
              bg: '#0b1220',
              card: '#0f172a',
              card2: '#111827',
              border: '#23314d',
              text: '#e5e7eb',
              mute: '#9ca3af',
              accent: '#22c55e',
              accent2: '#38bdf8',
              warn: '#f59e0b',
              danger: '#ef4444'
            }
          }
        }
      }
    }
  </script>
  <style>
    .card-hover{transition:transform .2s ease, box-shadow .2s ease}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.35)}
    .backdrop{backdrop-filter: blur(6px)}
    input[type="checkbox"]{accent-color:#22c55e}
  </style>
</head>
<body class="min-h-screen bg-[color:var(--twc,theme(colors.base.bg))] text-[color:var(--twt,theme(colors.base.text))]">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-slate-900/70 backdrop border-b border-[color:var(--twb,theme(colors.base.border))]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-[color:var(--twa,theme(colors.base.accent))] grid place-items-center text-slate-900 font-bold">MS</div>
        <h1 class="text-xl font-semibold text-white">My Safety</h1>
      </div>
      <nav class="hidden sm:flex gap-1">
        <button data-tab="wanted" class="tab-btn px-3 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 text-white">Wanted</button>
        <button data-tab="missing" class="tab-btn px-3 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 text-white">Missing Persons</button>
        <button data-tab="report" class="tab-btn px-3 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 text-white">Report to Police</button>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
    <!-- Tabs for mobile -->
    <div class="sm:hidden mb-6">
      <select id="tabSelect" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-[color:var(--twc,theme(colors.base.card))] text-white">
        <option value="wanted">Wanted Criminals</option>
        <option value="missing">Missing Persons</option>
        <option value="report">Report Missing to Police</option>
      </select>
    </div>

    <!-- WANTED DASHBOARD -->
    <section id="tab-wanted" class="tab">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-white">Wanted Criminals</h2>
        <div class="flex gap-2">
          <input id="searchWanted" placeholder="Search name, crime, area…" class="w-64 max-w-[60vw] border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 text-sm bg-[color:var(--twc,theme(colors.base.card))] placeholder-[color:var(--twm,theme(colors.base.mute))] text-white"/>
          <button id="refreshWanted" class="px-3 py-2 text-sm rounded-lg bg-slate-800 text-white hover:bg-slate-700 border border-[color:var(--twb,theme(colors.base.border))]">Refresh</button>
        </div>
      </div>
      <div id="wantedGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <!-- MISSING PERSONS DASHBOARD -->
    <section id="tab-missing" class="tab hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-white">Missing Persons</h2>
        <div class="flex gap-2">
          <input id="searchMissing" placeholder="Search name, hometown…" class="w-64 max-w-[60vw] border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 text-sm bg-[color:var(--twc,theme(colors.base.card))] placeholder-[color:var(--twm,theme(colors.base.mute))] text-white"/>
          <button id="refreshMissing" class="px-3 py-2 text-sm rounded-lg bg-slate-800 text-white hover:bg-slate-700 border border-[color:var(--twb,theme(colors.base.border))]">Refresh</button>
        </div>
      </div>
      <div id="missingGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <!-- REPORT MISSING TO POLICE -->
    <section id="tab-report" class="tab hidden">
      <h2 class="text-2xl font-semibold mb-4 text-white">Report Missing to Police</h2>
      <p class="text-sm text-[color:var(--twm,theme(colors.base.mute))] mb-6">Fill in the details. The report will be forwarded to the nearest police station and a case ID will be generated.</p>

      <form id="reportForm" class="bg-[color:var(--twc,theme(colors.base.card))] rounded-2xl border border-[color:var(--twb,theme(colors.base.border))] p-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-white">
        <!-- Person details -->
        <div class="md:col-span-2">
          <h3 class="font-semibold text-lg mb-2">Person Details</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Full Name</label>
              <input name="full_name" required class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white placeholder-[color:var(--twm,theme(colors.base.mute))]" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Nickname</label>
              <input name="nickname" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white placeholder-[color:var(--twm,theme(colors.base.mute))]" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Hometown</label>
              <input name="hometown" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white placeholder-[color:var(--twm,theme(colors.base.mute))]" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Age</label>
              <input name="age" type="number" min="0" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Weight (kg)</label>
              <input name="weight_kg" type="number" min="0" step="0.1" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Hair Color</label>
              <input name="hair_color" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white placeholder-[color:var(--twm,theme(colors.base.mute))]" />
            </div>
            <div class="sm:col-span-2">
              <label class="block text-sm font-medium mb-1">Photo Upload</label>
              <input name="photo_file" type="file" accept="image/*" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
          </div>
        </div>

        <!-- Last seen -->
        <div class="md:col-span-2">
          <h3 class="font-semibold text-lg mb-2">Last Seen</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Time & Date</label>
              <input name="last_seen_time" type="datetime-local" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Location</label>
              <div class="flex gap-2">
                <input name="last_seen_location" class="flex-1 border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white placeholder-[color:var(--twm,theme(colors.base.mute))]" />
                <button type="button" data-target="last_seen_location" class="geo-btn px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-[color:var(--twb,theme(colors.base.border))]">Use my location</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Description (height, blood group, clothing, marks, medical attention, etc.)</label>
          <textarea name="description" rows="5" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" placeholder="Add height, blood group, clothing, birthmarks/scars, medical attention if needed, etc."></textarea>
        </div>

        <!-- Reporter -->
        <div class="md:col-span-2">
          <h3 class="font-semibold text-lg mb-2">Reporter Contact</h3>
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Your Name</label>
              <input name="reporter_name" required class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Phone</label>
              <input name="reporter_phone" required class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Email</label>
              <input name="reporter_email" type="email" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Reporter Relation</label>
              <input name="reporter_relation" placeholder="Parent / sibling / neighbor / other" class="w-full border border-[color:var(--twb,theme(colors.base.border))] rounded-lg px-3 py-2 bg-slate-900 text-white placeholder-[color:var(--twm,theme(colors.base.mute))]" />
            </div>
          </div>
        </div>

        <div class="md:col-span-2 flex items-center justify-between">
          <div class="text-xs text-[color:var(--twm,theme(colors.base.mute))]">By submitting, you consent to share these details with law enforcement.</div>
          <button class="px-4 py-2 rounded-lg bg-[color:var(--twa,theme(colors.base.accent))] text-slate-900 font-semibold hover:brightness-110">Submit Report</button>
        </div>
      </form>

      <div id="reportSuccess" class="hidden mt-4 p-4 rounded-xl bg-emerald-900/40 border border-emerald-700 text-emerald-300">✅ Report submitted successfully. Case ID: <span class="font-mono" id="caseId"></span></div>
    </section>

    <!-- Dev/Test Panel -->
    <section class="mt-10" aria-label="Developer Tests">
      <div class="bg-[color:var(--twc,theme(colors.base.card2))] rounded-2xl border border-[color:var(--twb,theme(colors.base.border))] p-4">
        <div class="flex items-center justify-between gap-3">
          <h3 class="text-white font-semibold">Dev · Self Tests</h3>
          <button id="runTests" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm border border-[color:var(--twb,theme(colors.base.border))] hover:bg-slate-700">Run tests</button>
        </div>
        <ul id="testResults" class="mt-3 space-y-2 text-sm"></ul>
      </div>
    </section>
  </main>

  <!-- Details Modal / Action Drawer -->
  <div id="detailsModal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/60 backdrop"></div>
    <div class="relative z-10 max-w-2xl mx-auto mt-16 bg-[color:var(--twc,theme(colors.base.card2))] text-white rounded-2xl border border-[color:var(--twb,theme(colors.base.border))] shadow-xl overflow-hidden">
      <div class="flex items-center justify-between border-b border-[color:var(--twb,theme(colors.base.border))] px-5 py-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Details</h3>
        <button id="closeModal" class="p-2 hover:bg-slate-800 rounded-lg" aria-label="Close"><i data-lucide="x"></i></button>
      </div>
      <div id="modalBody" class="p-5"></div>
    </div>
  </div>

  <script>
    'use strict';
    // --- Mock data (replace with API calls) ----------------------------------
    const wantedData = [
      {id:1, name:"Rahim Uddin", photo_url:"https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=600&auto=format&fit=crop", crimes:["Robbery","Extortion"], last_seen_location:"Mirpur, Dhaka", last_seen_time:"2025-09-25T18:30:00", reward:50000, note:"Considered dangerous."},
      {id:2, name:"Tariq Hasan", photo_url:"https://images.unsplash.com/photo-1542202229-7d93c33f5d07?q=80&w=600&auto=format&fit=crop", crimes:["Fraud"], last_seen_location:"Agrabad, Chattogram", last_seen_time:"2025-09-20T14:10:00", reward:20000, note:"Drives a black sedan."},
      {id:3, name:"Unknown Alias 'Blue'", photo_url:"https://images.unsplash.com/photo-1488426862026-3ee34a7d66df?q=80&w=600&auto=format&fit=crop", crimes:["Burglary"], last_seen_location:"Uttara, Dhaka", last_seen_time:"2025-09-28T05:45:00", reward:0, note:"Seen near construction sites."}
    ];

    const missingData = [
      {id:11, name:"Shahin Alam", nickname:"Shuvo", photo_url:"https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=600&auto=format&fit=crop", hometown:"Gazipur", age:16, weight_kg:52, hair_color:"Black", last_seen_time:"2025-09-30T19:00:00", last_seen_location:"Jatrabari, Dhaka", description:"Wearing blue t-shirt, white sneakers.", still_with_finder:false},
      {id:12, name:"Nusrat Jahan", nickname:"Nusa", photo_url:"https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=600&auto=format&fit=crop", hometown:"Narayanganj", age:8, weight_kg:24, hair_color:"Brown", last_seen_time:"2025-09-29T17:30:00", last_seen_location:"Motijheel, Dhaka", description:"Pink frock, cartoon backpack.", still_with_finder:true}
    ];

    // --- Utilities -----------------------------------------------------------
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $  = (sel, root=document) => root.querySelector(sel);
    const fmt = (dt) => dt ? new Date(dt).toLocaleString() : "";

    // Geo helper to fill any input[name=...]
    function fillWithGeo(inputEl){
      if(!navigator.geolocation){ alert('Geolocation not supported on this browser.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        inputEl.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      }, err=>{
        alert('Unable to get location: '+ err.message);
      }, {enableHighAccuracy:true, timeout:10000});
    }

    // --- Tabs ---------------------------------------------------------------
    function setActiveTab(id){
      $$(".tab").forEach(s=>s.classList.add("hidden"));
      $("#tab-"+id).classList.remove("hidden");
      $$(".tab-btn").forEach(b=>{
        const active = b.dataset.tab===id;
        b.classList.toggle("bg-slate-200", false);
        b.classList.toggle("bg-slate-800", active);
        b.classList.toggle("text-white", true);
      });
    }
    $$(".tab-btn").forEach(btn=>btn.addEventListener("click",()=>{ setActiveTab(btn.dataset.tab) }));
    $("#tabSelect").addEventListener("change", e=> setActiveTab(e.target.value));
    setActiveTab("wanted");

    // --- Render Wanted ------------------------------------------------------
    function wantedCard(item){
      const card = document.createElement("div");
      card.className = "card-hover bg-[color:var(--twc,theme(colors.base.card))] rounded-2xl border border-[color:var(--twb,theme(colors.base.border))] overflow-hidden";
      card.innerHTML = `
        <img src="${item.photo_url}" alt="${item.name}" class="w-full h-44 object-cover"/>
        <div class="p-4">
          <div class="flex items-center justify-between mb-1">
            <h3 class="font-semibold text-white">${item.name}</h3>
            <span class="text-xs px-2 py-1 rounded-full bg-red-900/40 text-red-300 border border-red-800">Wanted</span>
          </div>
          <p class="text-sm text-[color:var(--twm,theme(colors.base.mute))]">Last seen: ${item.last_seen_location} · ${fmt(item.last_seen_time)}</p>
          <div class="flex gap-2 mt-3">
            <button class="show-details px-3 py-2 rounded-lg bg-slate-800 text-white text-sm border border-[color:var(--twb,theme(colors.base.border))] hover:bg-slate-700">Show details</button>
          </div>
        </div>`;
      card.querySelector('.show-details').addEventListener('click',()=>openWantedModal(item));
      return card;
    }
    function renderWanted(list){
      const grid = $("#wantedGrid");
      grid.innerHTML = "";
      list.forEach(item=> grid.appendChild(wantedCard(item)));
    }

    function openWantedModal(item){
      $("#modalTitle").textContent = item.name + " – Details";
      $("#modalBody").innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <img src="${item.photo_url}" class="sm:col-span-1 w-full h-40 object-cover rounded-xl"/>
          <div class="sm:col-span-2 text-sm space-y-2">
            <p><span class="font-medium">Crimes:</span> ${item.crimes.join(', ')}</p>
            <p><span class="font-medium">Last seen:</span> ${item.last_seen_location} at ${fmt(item.last_seen_time)}</p>
            <p><span class="font-medium">Reward:</span> ৳${item.reward.toLocaleString()}</p>
            <p class="text-[color:var(--twm,theme(colors.base.mute))]">${item.note||''}</p>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="seenBtn" class="px-3 py-2 rounded-lg bg-[color:var(--twa,theme(colors.base.accent))] text-slate-900 text-sm font-semibold">I have seen this person</button>
            </div>
            <div id="seenFormWrap" class="hidden mt-4 p-4 rounded-xl bg-slate-900/60 border border-[color:var(--twb,theme(colors.base.border))]">
              <h4 class="font-semibold mb-3">Report Last Seen (Will notify police)</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs mb-1">Last Seen Time</label>
                  <input id="seen_time" type="datetime-local" class="w-full rounded-lg px-3 py-2 bg-slate-900 border border-[color:var(--twb,theme(colors.base.border))] text-white"/>
                </div>
                <div>
                  <label class="block text-xs mb-1">Last Seen Location</label>
                  <div class="flex gap-2">
                    <input id="seen_location" class="flex-1 rounded-lg px-3 py-2 bg-slate-900 border border-[color:var(--twb,theme(colors.base.border))] text-white" placeholder="Type address or use my location"/>
                    <button type="button" id="geoSeen" class="px-3 py-2 rounded-lg bg-slate-800 border border-[color:var(--twb,theme(colors.base.border))] hover:bg-slate-700"><i data-lucide="crosshair"></i></button>
                  </div>
                </div>
              </div>
              <div class="mt-3 flex justify-end">
                <button id="submitSeen" class="px-3 py-2 rounded-lg bg-[color:var(--twa,theme(colors.base.accent2))] text-slate-900 font-semibold">Send Notification</button>
              </div>
            </div>
          </div>
        </div>`;
      toggleModal(true);
      lucide.createIcons();
      // Wire actions
      const seenBtn = $("#seenBtn");
      const wrap = $("#seenFormWrap");
      seenBtn.addEventListener('click', ()=> wrap.classList.toggle('hidden'));
      $("#geoSeen").addEventListener('click', ()=> fillWithGeo($("#seen_location")));
      $("#submitSeen").addEventListener('click', ()=>{
        const payload = {
          criminal_id: item.id,
          last_seen_time: $("#seen_time").value,
          last_seen_location: $("#seen_location").value
        };
        // TODO: POST /api/wanted/seen -> notify police
        alert(`🚓 Notification sent to police with your sighting.

${JSON.stringify(payload, null, 2)}`);
        toggleModal(false);
      });
    }

    // --- Render Missing -----------------------------------------------------
    function missingCard(item){
      const card = document.createElement('div');
      card.className = "card-hover bg-[color:var(--twc,theme(colors.base.card))] rounded-2xl border border-[color:var(--twb,theme(colors.base.border))] overflow-hidden";
      card.innerHTML = `
        <img src="${item.photo_url}" alt="${item.name}" class="w-full h-44 object-cover"/>
        <div class="p-4">
          <div class="flex items-center justify-between mb-1">
            <h3 class="font-semibold text-white">${item.name} <span class="text-[color:var(--twm,theme(colors.base.mute))] font-normal">(${item.nickname||'—'})</span></h3>
            <span class="text-xs px-2 py-1 rounded-full ${item.still_with_finder?'bg-emerald-900/40 text-emerald-300 border border-emerald-800':'bg-amber-900/40 text-amber-300 border border-amber-800'}">${item.still_with_finder? 'With finder' : 'Unknown'}</span>
          </div>
          <p class="text-sm text-[color:var(--twm,theme(colors.base.mute))]">Hometown: ${item.hometown||'—'}</p>
          <p class="text-sm text-[color:var(--twm,theme(colors.base.mute))]">Last seen: ${item.last_seen_location} · ${fmt(item.last_seen_time)}</p>
          <div class="mt-3 flex flex-wrap gap-2 items-center">
            <button class="details-missing px-3 py-2 rounded-lg bg-slate-800 text-white text-sm border border-[color:var(--twb,theme(colors.base.border))] hover:bg-slate-700">Show details</button>
          </div>
        </div>`;
      card.querySelector('.details-missing').addEventListener('click',()=>openMissingModal(item));
      return card;
    }
    function renderMissing(list){
      const grid = $("#missingGrid");
      grid.innerHTML = "";
      list.forEach(item=> grid.appendChild(missingCard(item)));
    }

    function openMissingModal(item){
      $("#modalTitle").textContent = item.name + " – Details";
      $("#modalBody").innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <img src="${item.photo_url}" class="sm:col-span-1 w-full h-40 object-cover rounded-xl"/>
          <div class="sm:col-span-2 text-sm space-y-2">
            <p><span class="font-medium">Nickname:</span> ${item.nickname||'—'}</p>
            <p><span class="font-medium">Age:</span> ${item.age||'—'} | <span class="font-medium">Weight:</span> ${item.weight_kg||'—'} kg | <span class="font-medium">Hair:</span> ${item.hair_color||'—'}</p>
            <p><span class="font-medium">Hometown:</span> ${item.hometown||'—'}</p>
            <p><span class="font-medium">Last seen:</span> ${item.last_seen_location} at ${fmt(item.last_seen_time)}</p>
            <p class="text-[color:var(--twm,theme(colors.base.mute))]">${item.description||''}</p>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="foundBtn" class="px-3 py-2 rounded-lg bg-[color:var(--twa,theme(colors.base.accent))] text-slate-900 text-sm font-semibold">Found</button>
              <button id="toggleFinderBtn" class="px-3 py-2 rounded-lg bg-slate-800 text-white text-sm border border-[color:var(--twb,theme(colors.base.border))] hover:bg-slate-700">Still with finder</button>
            </div>
          </div>
        </div>`;
      toggleModal(true);
      $("#foundBtn").addEventListener('click', ()=>{
        // TODO: POST /api/missing/found -> notify police + relatives
        alert('📣 Notification sent to police and relatives that the person has been found.');
        toggleModal(false);
      });
      $("#toggleFinderBtn").addEventListener('click', ()=>{
        item.still_with_finder = !item.still_with_finder;
        renderMissing(missingData.filter(filterMissing));
        // TODO: PATCH /api/missing/:id {still_with_finder}
        toggleModal(false);
      });
    }

    // --- Modal controls -----------------------------------------------------
    function toggleModal(show){
      const m = $("#detailsModal");
      if(show){ m.classList.remove('hidden'); } else { m.classList.add('hidden'); }
      lucide.createIcons();
    }
    $("#closeModal").addEventListener('click', ()=>toggleModal(false));
    $("#detailsModal").addEventListener('click', (e)=>{ if(e.target.id==='detailsModal') toggleModal(false) });

    // --- Searching & refresh ------------------------------------------------
    function filterWanted(item){
      const q = $("#searchWanted").value.trim().toLowerCase();
      if(!q) return true;
      return item.name.toLowerCase().includes(q) || item.last_seen_location.toLowerCase().includes(q) || item.crimes.join(' ').toLowerCase().includes(q);
    }
    function filterMissing(item){
      const q = $("#searchMissing").value.trim().toLowerCase();
      if(!q) return true;
      return item.name.toLowerCase().includes(q) || (item.hometown||'').toLowerCase().includes(q) || (item.nickname||'').toLowerCase().includes(q);
    }

    $("#searchWanted").addEventListener('input', ()=>renderWanted(wantedData.filter(filterWanted)));
    $("#searchMissing").addEventListener('input', ()=>renderMissing(missingData.filter(filterMissing)));
    $("#refreshWanted").addEventListener('click', ()=>{ renderWanted(wantedData.filter(filterWanted)); });
    $("#refreshMissing").addEventListener('click', ()=>{ renderMissing(missingData.filter(filterMissing)); });

    // Geo buttons in Report form
    $$(".geo-btn").forEach(btn=> btn.addEventListener('click', ()=>{
      const name = btn.getAttribute('data-target');
      const el = document.querySelector(`[name="${name}"]`);
      if(el) fillWithGeo(el);
    }));

    // --- Report form submit -------------------------------------------------
    $("#reportForm").addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      // NOTE: photo_file is a File; send via multipart/form-data to backend
      // TODO: await fetch('/api/reports/missing', {method:'POST', body: fd});
      const generatedId = 'MS-' + Math.floor(100000 + Math.random()*900000);
      $("#caseId").textContent = generatedId;
      $("#reportSuccess").classList.remove('hidden');
      e.target.reset();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // --- Self Tests ---------------------------------------------------------
    function runTests(){
      const out = document.getElementById('testResults');
      out.innerHTML = '';
      const results = [];
      const assert = (name, cond) => results.push({name, pass: !!cond});

      try {
        // fmt tests
        assert('fmt(null) returns empty string', fmt(null) === '');
        assert('fmt("") returns empty string', fmt('') === '');
        const sampleFmt = fmt('2025-09-25T18:30:00');
        assert('fmt(date) returns non-empty string', typeof sampleFmt === 'string' && sampleFmt.length > 0);

        // filterWanted tests
        document.getElementById('searchWanted').value = 'rahim';
        assert('filterWanted matches by name', filterWanted(wantedData[0]) === true);
        document.getElementById('searchWanted').value = 'fraud';
        assert('filterWanted matches by crime keyword', filterWanted(wantedData[1]) === true);
        document.getElementById('searchWanted').value = 'no-match';
        assert('filterWanted returns false on no match', filterWanted(wantedData[0]) === false);

        // filterMissing tests
        document.getElementById('searchMissing').value = 'Nusrat';
        assert('filterMissing matches by name', filterMissing(missingData[1]) === true);
        document.getElementById('searchMissing').value = 'gazipur';
        assert('filterMissing matches by hometown', filterMissing(missingData[0]) === true);

        // openMissingModal behavior
        document.getElementById('searchMissing').value = '';
        renderMissing(missingData);
        const firstMissingBtn = document.querySelector('#missingGrid .details-missing');
        firstMissingBtn.click();
        assert('Modal has Found button', !!document.getElementById('foundBtn'));
        assert('Modal has Still-with-finder button', !!document.getElementById('toggleFinderBtn'));
        document.getElementById('closeModal').click();

        // openWantedModal behavior
        document.getElementById('searchWanted').value = '';
        renderWanted(wantedData);
        const firstCardBtn = document.querySelector('#wantedGrid .show-details');
        firstCardBtn.click();
        const seenBtn = document.getElementById('seenBtn');
        assert('Show details renders seenBtn', !!seenBtn);
        seenBtn.click();
        const seenForm = document.getElementById('seenFormWrap');
        assert('Clicking seenBtn reveals form', !seenForm.classList.contains('hidden'));
        document.getElementById('closeModal').click();

      } catch (e) {
        results.push({name: 'Tests crashed', pass: false, error: e.message});
      }

      // Render results
      for(const r of results){
        const li = document.createElement('li');
        li.className = r.pass ? 'text-emerald-300' : 'text-red-300';
        li.textContent = (r.pass ? '✔ ' : '✖ ') + r.name + (r.error ? ' — ' + r.error : '');
        out.appendChild(li);
      }
    }

    document.getElementById('runTests').addEventListener('click', runTests);

    // --- First render -------------------------------------------------------
    renderWanted(wantedData);
    renderMissing(missingData);
    lucide.createIcons();
  </script>

  <!--
  ========================= BACKEND BLUEPRINT (MySQL) =========================

  -- WANTED CRIMINALS
  CREATE TABLE wanted_criminals (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(120) NOT NULL,
    photo_url VARCHAR(500),
    last_seen_location VARCHAR(200),
    last_seen_time DATETIME,
    reward_bdt INT DEFAULT 0,
    note TEXT,
    status ENUM('wanted','caught','inactive') DEFAULT 'wanted'
  );

  CREATE TABLE criminal_offenses (
    id INT AUTO_INCREMENT PRIMARY KEY,
    criminal_id INT NOT NULL,
    offense VARCHAR(200) NOT NULL,
    FOREIGN KEY (criminal_id) REFERENCES wanted_criminals(id) ON DELETE CASCADE
  );

  -- MISSING PERSONS
  CREATE TABLE missing_persons (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(120) NOT NULL,
    nickname VARCHAR(120),
    hometown VARCHAR(120),
    age INT,
    weight_kg DECIMAL(5,2),
    hair_color VARCHAR(60),
    photo_url VARCHAR(500),
    last_seen_location VARCHAR(200),
    last_seen_time DATETIME,
    description TEXT,
    still_with_finder TINYINT(1) DEFAULT 0,
    status ENUM('open','found','closed') DEFAULT 'open'
  );

  -- REPORTS TO POLICE (MISSING) — updated for relation + photo upload
  CREATE TABLE missing_reports (
    id INT AUTO_INCREMENT PRIMARY KEY,
    person_name VARCHAR(120) NOT NULL,
    nickname VARCHAR(120),
    hometown VARCHAR(120),
    age INT,
    weight_kg DECIMAL(5,2),
    hair_color VARCHAR(60),
    photo_path VARCHAR(500), -- store path after upload (recommended)
    last_seen_location VARCHAR(200),
    last_seen_time DATETIME,
    description TEXT,
    reporter_name VARCHAR(120) NOT NULL,
    reporter_phone VARCHAR(40) NOT NULL,
    reporter_email VARCHAR(120),
    reporter_relation VARCHAR(60),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  );

  -- Minimal REST endpoints (Node/Express, Flask, or PHP)
  GET    /api/wanted                 -> list wanted criminals (JOIN offenses)
  GET    /api/wanted/:id            -> single criminal + offenses
  POST   /api/wanted/seen           -> {criminal_id, last_seen_time, last_seen_location}  (notify police)

  GET    /api/missing               -> list missing persons
  PATCH  /api/missing/:id           -> update still_with_finder
  POST   /api/missing/found         -> {person_id}  (notify police & relatives)

  POST   /api/reports/missing       -> multipart/form-data (photo_file + fields); store file, save photo_path

  Example SQL:
  SELECT w.*, GROUP_CONCAT(o.offense SEPARATOR ',') AS offenses
  FROM wanted_criminals w LEFT JOIN criminal_offenses o ON o.criminal_id=w.id
  GROUP BY w.id;

  UPDATE missing_persons SET still_with_finder=? WHERE id=?;

  INSERT INTO missing_reports (...columns...) VALUES (...values...);
  ==========================================================================
  -->
</body>
</html>
